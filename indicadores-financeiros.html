import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  LayoutDashboard, 
  Database, 
  Calculator, 
  TrendingUp, 
  Download, 
  Upload, 
  Plus, 
  ChevronRight, 
  Home, 
  Settings,
  Info,
  DollarSign,
  ArrowUpRight,
  ArrowDownRight,
  Trash2,
  Calendar,
  BarChart3,
  LineChart,
  RefreshCcw
} from 'lucide-react';
import Chart from 'chart.js/auto';

const App = () => {
  // --- Estados Principais ---
  const [activeTab, setActiveTab] = useState('dashboard');
  const [history, setHistory] = useState([]);
  const [selectedPeriods, setSelectedPeriods] = useState({ p1: 0, p2: 1 });
  const [chartType, setChartType] = useState('line');
  
  // Estado para o formulário de nova entrada
  const [newEntry, setNewEntry] = useState({
    periodo: '',
    receitaBruta: 0,
    custos: 0,
    despesasOp: 0,
    ativoCirculante: 0,
    passivoCirculante: 0,
    patrimonioLiquido: 0,
    ativoTotal: 0,
    lucroLiquido: 0
  });

  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // --- Funções de Cálculo ---
  const calculateIndicators = (item) => {
    if (!item) return {};
    return {
      liquidezCorrente: item.ativoCirculante / (item.passivoCirculante || 1),
      margemLiquida: (item.lucroLiquido / (item.receitaBruta || 1)) * 100,
      roe: (item.lucroLiquido / (item.patrimonioLiquido || 1)) * 100,
      ebitda: item.receitaBruta - item.custos - item.despesasOp,
      endividamento: ((item.ativoTotal - item.patrimonioLiquido) / (item.ativoTotal || 1)) * 100,
      giroAtivo: item.receitaBruta / (item.ativoTotal || 1)
    };
  };

  const historyWithIndicators = useMemo(() => {
    return history.map(item => ({
      ...item,
      indicators: calculateIndicators(item)
    }));
  }, [history]);

  // --- Handlers de Dados ---
  const handleAddEntry = (e) => {
    e.preventDefault();
    if (history.length >= 36) {
      alert("Limite de 36 séries atingido.");
      return;
    }
    const updatedHistory = [...history, { ...newEntry, id: Date.now() }];
    setHistory(updatedHistory);
    setNewEntry({ periodo: '', receitaBruta: 0, custos: 0, despesasOp: 0, ativoCirculante: 0, passivoCirculante: 0, patrimonioLiquido: 0, ativoTotal: 0, lucroLiquido: 0 });
  };

  const removeEntry = (id) => {
    setHistory(history.filter(item => item.id !== id));
  };

  const generateMockHistory = () => {
    const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    const years = ["2023", "2024", "2025"];
    let mock = [];
    let count = 0;
    
    for (let y of years) {
      for (let m of months) {
        if (count >= 36) break;
        const base = 1000000 + (Math.random() * 500000);
        mock.push({
          id: count,
          periodo: `${m}/${y}`,
          receitaBruta: base,
          custos: base * 0.6,
          despesasOp: base * 0.15,
          ativoCirculante: base * 0.4,
          passivoCirculante: base * 0.25,
          patrimonioLiquido: base * 0.6,
          ativoTotal: base * 1.2,
          lucroLiquido: base * 0.12
        });
        count++;
      }
    }
    setHistory(mock);
    setSelectedPeriods({ p1: mock.length - 2, p2: mock.length - 1 });
  };

  // --- Lógica do Gráfico ---
  useEffect(() => {
    if (activeTab === 'dashboard' && chartRef.current && history.length > 0) {
      if (chartInstance.current) chartInstance.current.destroy();

      const ctx = chartRef.current.getContext('2d');
      chartInstance.current = new Chart(ctx, {
        type: chartType,
        data: {
          labels: historyWithIndicators.map(d => d.periodo),
          datasets: [
            {
              label: 'Margem Líquida (%)',
              data: historyWithIndicators.map(d => d.indicators.margemLiquida),
              borderColor: '#c5a059',
              backgroundColor: 'rgba(197, 160, 89, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'ROE (%)',
              data: historyWithIndicators.map(d => d.indicators.roe),
              borderColor: '#0f172a',
              backgroundColor: 'rgba(15, 23, 42, 0.1)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top', labels: { font: { weight: 'bold', size: 10 } } } },
          scales: {
            y: { beginAtZero: false, grid: { color: '#f1f5f9' } },
            x: { grid: { display: false } }
          }
        }
      });
    }
  }, [historyWithIndicators, activeTab, chartType]);

  // Cálculo de Comparação
  const compP1 = historyWithIndicators[selectedPeriods.p1];
  const compP2 = historyWithIndicators[selectedPeriods.p2];

  const getDelta = (val1, val2) => {
    if (!val1 || !val2) return 0;
    return ((val2 - val1) / Math.abs(val1)) * 100;
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
      
      {/* HEADER */}
      <header className="bg-white border-b border-slate-200 h-20 flex items-center px-8 justify-between sticky top-0 z-50">
        <div className="flex items-center gap-2">
          <div className="bg-slate-900 text-amber-500 p-2 rounded-lg">
            <LayoutDashboard className="w-6 h-6" />
          </div>
          <span className="text-xl font-black tracking-tighter uppercase italic">Audit<span className="text-amber-500">Educa</span></span>
        </div>
        
        <div className="flex items-center gap-4">
          <nav className="hidden md:flex bg-slate-100 p-1 rounded-xl">
            <button 
              onClick={() => setActiveTab('dashboard')}
              className={`px-5 py-2 rounded-lg text-xs font-black transition flex items-center gap-2 ${activeTab === 'dashboard' ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-400'}`}
            >
              <BarChart3 className="w-4 h-4" /> Dashboard
            </button>
            <button 
              onClick={() => setActiveTab('data')}
              className={`px-5 py-2 rounded-lg text-xs font-black transition flex items-center gap-2 ${activeTab === 'data' ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-400'}`}
            >
              <Database className="w-4 h-4" /> Gestão de Dados
            </button>
          </nav>
          <div className="h-8 w-px bg-slate-200 mx-2"></div>
          <button className="p-2 text-slate-400 hover:text-amber-500"><Settings className="w-5 h-5" /></button>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        {/* Breadcrumb */}
        <nav className="flex items-center gap-2 text-[10px] font-black uppercase text-slate-400 mb-8 tracking-widest">
          <Home className="w-3 h-3" /> Home <ChevronRight className="w-3 h-3" /> Controladoria <ChevronRight className="w-3 h-3" /> {activeTab === 'dashboard' ? 'Análise Histórica' : 'Entrada de Séries'}
        </nav>

        {activeTab === 'dashboard' ? (
          <div className="space-y-8 animate-in fade-in duration-500">
            
            {history.length === 0 ? (
              <div className="bg-white rounded-[2.5rem] p-20 text-center border border-dashed border-slate-300">
                <div className="bg-slate-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                  <Database className="w-10 h-10 text-slate-200" />
                </div>
                <h2 className="text-2xl font-black text-slate-400">Nenhum dado encontrado</h2>
                <p className="text-slate-400 mt-2 mb-8">Comece por adicionar períodos manualmente ou importe o histórico.</p>
                <button onClick={generateMockHistory} className="bg-amber-500 text-slate-900 px-8 py-4 rounded-2xl font-black hover:bg-amber-600 transition flex items-center gap-2 mx-auto">
                  <RefreshCcw className="w-5 h-5" /> Gerar 36 Meses de Exemplo
                </button>
              </div>
            ) : (
              <>
                {/* Seletores de Comparação */}
                <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-wrap items-center justify-between gap-6">
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2">
                      <span className="text-[10px] font-black text-slate-400 uppercase">Base:</span>
                      <select 
                        value={selectedPeriods.p1}
                        onChange={(e) => setSelectedPeriods(prev => ({ ...prev, p1: parseInt(e.target.value) }))}
                        className="bg-slate-50 border-none rounded-lg text-xs font-bold p-2 outline-none focus:ring-2 focus:ring-amber-500"
                      >
                        {history.map((item, idx) => <option key={idx} value={idx}>{item.periodo}</option>)}
                      </select>
                    </div>
                    <span className="text-slate-300 font-bold">vs</span>
                    <div className="flex items-center gap-2">
                      <span className="text-[10px] font-black text-slate-400 uppercase">Comparação:</span>
                      <select 
                        value={selectedPeriods.p2}
                        onChange={(e) => setSelectedPeriods(prev => ({ ...prev, p2: parseInt(e.target.value) }))}
                        className="bg-slate-50 border-none rounded-lg text-xs font-bold p-2 outline-none focus:ring-2 focus:ring-amber-500"
                      >
                        {history.map((item, idx) => <option key={idx} value={idx}>{item.periodo}</option>)}
                      </select>
                    </div>
                  </div>
                  
                  <div className="flex bg-slate-100 p-1 rounded-xl">
                    <button onClick={() => setChartType('line')} className={`p-2 rounded-lg transition ${chartType === 'line' ? 'bg-white shadow-sm text-amber-600' : 'text-slate-400'}`}><LineChart className="w-4 h-4" /></button>
                    <button onClick={() => setChartType('bar')} className={`p-2 rounded-lg transition ${chartType === 'bar' ? 'bg-white shadow-sm text-amber-600' : 'text-slate-400'}`}><BarChart3 className="w-4 h-4" /></button>
                  </div>
                </div>

                {/* Grid de Indicadores Comparativos */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                  <ComparisonCard 
                    label="Liquidez Corrente" 
                    val1={compP1?.indicators.liquidezCorrente} 
                    val2={compP2?.indicators.liquidezCorrente} 
                    format="number"
                  />
                  <ComparisonCard 
                    label="Margem Líquida" 
                    val1={compP1?.indicators.margemLiquida} 
                    val2={compP2?.indicators.margemLiquida} 
                    format="percent"
                  />
                  <ComparisonCard 
                    label="ROE" 
                    val1={compP1?.indicators.roe} 
                    val2={compP2?.indicators.roe} 
                    format="percent"
                  />
                  <ComparisonCard 
                    label="EBITDA" 
                    val1={compP1?.indicators.ebitda} 
                    val2={compP2?.indicators.ebitda} 
                    format="currency"
                  />
                </div>

                {/* Área de Gráfico */}
                <div className="bg-white p-10 rounded-[2.5rem] border border-slate-100 shadow-sm">
                  <div className="flex items-center justify-between mb-10">
                    <div>
                      <h3 className="text-xl font-black text-slate-900">Tendência das Séries Históricas</h3>
                      <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Evolução de Performance em {history.length} períodos</p>
                    </div>
                    <button className="flex items-center gap-2 text-[10px] font-black uppercase text-amber-600 hover:bg-amber-50 p-2 rounded-lg transition">
                      <Download className="w-4 h-4" /> Exportar Dados
                    </button>
                  </div>
                  <div className="h-[400px]">
                    <canvas ref={chartRef}></canvas>
                  </div>
                </div>
              </>
            )}
          </div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in slide-in-from-bottom-6 duration-500">
            
            {/* Formulário de Inserção Manual */}
            <div className="lg:col-span-5">
              <div className="bg-white rounded-[2rem] p-8 border border-slate-100 shadow-sm sticky top-24">
                <div className="flex items-center justify-between mb-8">
                  <h3 className="text-xl font-black text-slate-900">Nova Série</h3>
                  <div className="text-[10px] font-bold bg-slate-100 px-3 py-1 rounded-full text-slate-500">
                    {history.length}/36 Séries
                  </div>
                </div>
                
                <form onSubmit={handleAddEntry} className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="col-span-2">
                      <label className="text-[10px] font-black uppercase text-slate-400 mb-1 block">Período (Ex: Jan/24)</label>
                      <input required type="text" value={newEntry.periodo} onChange={(e) => setNewEntry({...newEntry, periodo: e.target.value})} className="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Mês/Ano" />
                    </div>
                    <FormInput label="Receita Bruta" value={newEntry.receitaBruta} onChange={(v) => setNewEntry({...newEntry, receitaBruta: v})} />
                    <FormInput label="Lucro Líquido" value={newEntry.lucroLiquido} onChange={(v) => setNewEntry({...newEntry, lucroLiquido: v})} />
                    <FormInput label="Ativo Circulante" value={newEntry.ativoCirculante} onChange={(v) => setNewEntry({...newEntry, ativoCirculante: v})} />
                    <FormInput label="Passivo Circulante" value={newEntry.passivoCirculante} onChange={(v) => setNewEntry({...newEntry, passivoCirculante: v})} />
                    <FormInput label="Patrimônio Líquido" value={newEntry.patrimonioLiquido} onChange={(v) => setNewEntry({...newEntry, patrimonioLiquido: v})} />
                    <FormInput label="Ativo Total" value={newEntry.ativoTotal} onChange={(v) => setNewEntry({...newEntry, ativoTotal: v})} />
                    <FormInput label="Custos Vendas" value={newEntry.custos} onChange={(v) => setNewEntry({...newEntry, custos: v})} />
                    <FormInput label="Despesas Op." value={newEntry.despesasOp} onChange={(v) => setNewEntry({...newEntry, despesasOp: v})} />
                  </div>
                  <button type="submit" className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black mt-4 hover:bg-slate-800 transition flex items-center justify-center gap-2">
                    <Plus className="w-5 h-5" /> Adicionar ao Histórico
                  </button>
                </form>

                <div className="mt-6 pt-6 border-t border-slate-50">
                  <button onClick={generateMockHistory} className="w-full bg-amber-50 text-amber-700 py-3 rounded-xl font-bold text-xs hover:bg-amber-100 transition flex items-center justify-center gap-2">
                    <RefreshCcw className="w-4 h-4" /> Preencher Automaticamente (Demo)
                  </button>
                </div>
              </div>
            </div>

            {/* Listagem e Importação */}
            <div className="lg:col-span-7 space-y-6">
              <div className="bg-slate-900 rounded-[2rem] p-8 text-white flex items-center justify-between">
                <div>
                  <h4 className="font-black text-lg">Importação em Lote</h4>
                  <p className="text-xs text-slate-400">Arraste a sua folha de Excel para importar as 36 séries.</p>
                </div>
                <button className="bg-white/10 hover:bg-white/20 p-4 rounded-2xl transition">
                  <Upload className="w-6 h-6 text-amber-500" />
                </button>
              </div>

              <div className="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden">
                <div className="p-6 border-b border-slate-50">
                  <h4 className="font-black text-slate-900">Histórico de Séries Registadas</h4>
                </div>
                <div className="max-h-[600px] overflow-y-auto">
                  <table className="w-full text-left">
                    <thead className="bg-slate-50 sticky top-0">
                      <tr>
                        <th className="px-6 py-4 text-[10px] font-black uppercase text-slate-400">Período</th>
                        <th className="px-6 py-4 text-[10px] font-black uppercase text-slate-400">Receita</th>
                        <th className="px-6 py-4 text-[10px] font-black uppercase text-slate-400">Lucro L.</th>
                        <th className="px-6 py-4 text-[10px] font-black uppercase text-slate-400">Ações</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                      {history.slice().reverse().map((item) => (
                        <tr key={item.id} className="hover:bg-slate-50/50 transition">
                          <td className="px-6 py-4 font-bold text-xs text-slate-900">{item.periodo}</td>
                          <td className="px-6 py-4 font-medium text-xs text-slate-500">
                            {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(item.receitaBruta)}
                          </td>
                          <td className="px-6 py-4 font-medium text-xs text-slate-500">
                            {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(item.lucroLiquido)}
                          </td>
                          <td className="px-6 py-4">
                            <button onClick={() => removeEntry(item.id)} className="p-2 text-red-300 hover:text-red-500 transition">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  {history.length === 0 && (
                    <div className="p-10 text-center text-slate-300 italic text-sm">Sem séries temporais registadas.</div>
                  )}
                </div>
              </div>
            </div>

          </div>
        )}
      </main>

      <footer className="bg-slate-900 text-slate-400 py-12 mt-20">
        <div className="max-w-7xl mx-auto px-8 grid grid-cols-1 md:grid-cols-4 gap-12 border-b border-white/5 pb-12">
          <div className="col-span-1 md:col-span-2">
             <div className="flex items-center gap-2 mb-6">
                <div className="bg-white text-slate-900 p-1.5 rounded-md">
                  <Calculator className="w-5 h-5" />
                </div>
                <span className="text-white text-xl font-black tracking-tighter uppercase italic">Audit<span className="text-amber-500">Educa</span></span>
             </div>
             <p className="text-sm max-w-sm leading-relaxed">
               Inteligência contábil avançada com suporte a séries temporais complexas e auditoria preditiva.
             </p>
          </div>
          <div>
            <h5 className="text-white font-bold text-sm mb-4 uppercase tracking-widest">Suporte Tecnico</h5>
            <ul className="text-xs space-y-3">
              <li><a href="#" className="hover:text-amber-500 transition">Importação de XML/JSON</a></li>
              <li><a href="#" className="hover:text-amber-500 transition">API de Integração</a></li>
            </ul>
          </div>
          <div>
            <h5 className="text-white font-bold text-sm mb-4 uppercase tracking-widest">Jurídico</h5>
            <ul className="text-xs space-y-3">
              <li><a href="#" className="hover:text-amber-500 transition">Conformidade LGPD</a></li>
              <li><a href="#" className="hover:text-amber-500 transition">Termos de Auditoria</a></li>
            </ul>
          </div>
        </div>
        <div className="max-w-7xl mx-auto px-8 pt-8 text-[10px] font-black uppercase tracking-widest">
          <p>© 2026 AuditEduca - Financial Analysis Division</p>
        </div>
      </footer>
    </div>
  );
};

// --- Sub-componentes ---

const ComparisonCard = ({ label, val1, val2, format }) => {
  const delta = ((val2 - val1) / Math.abs(val1 || 1)) * 100;
  
  const formatVal = (v) => {
    if (v === undefined) return "---";
    if (format === 'percent') return v.toFixed(1) + "%";
    if (format === 'currency') return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', notation: 'compact' }).format(v);
    return v.toFixed(2);
  };

  return (
    <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
      <p className="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-4">{label}</p>
      <div className="flex items-end justify-between">
        <div>
          <p className="text-2xl font-black text-slate-900">{formatVal(val2)}</p>
          <p className="text-[10px] font-bold text-slate-400 mt-1 italic">vs {formatVal(val1)} no período anterior</p>
        </div>
        <div className={`flex items-center gap-1 text-xs font-black ${delta >= 0 ? 'text-green-500' : 'text-red-500'}`}>
          {delta >= 0 ? <ArrowUpRight className="w-3 h-3" /> : <ArrowDownRight className="w-3 h-3" />}
          {Math.abs(delta).toFixed(1)}%
        </div>
      </div>
      <div className="mt-4 h-1 w-full bg-slate-50 rounded-full overflow-hidden">
        <div className={`h-full transition-all duration-700 ${delta >= 0 ? 'bg-green-500' : 'bg-red-500'}`} style={{ width: `${Math.min(Math.abs(delta), 100)}%` }}></div>
      </div>
    </div>
  );
};

const FormInput = ({ label, value, onChange }) => (
  <div>
    <label className="text-[10px] font-black uppercase text-slate-400 mb-1 block">{label}</label>
    <div className="relative">
      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-slate-300">R$</span>
      <input 
        type="number" 
        value={value} 
        onChange={(e) => onChange(parseFloat(e.target.value) || 0)} 
        className="w-full bg-slate-50 border-none rounded-xl py-2 pl-8 pr-3 text-xs font-bold focus:ring-2 focus:ring-amber-500 outline-none" 
      />
    </div>
  </div>
);

export default App;